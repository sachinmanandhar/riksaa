<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 100%;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
    <title>Real TIme Location example</title>
  </head>
  <body>
    <h2>Real TIme Location example</h2>
    <div id="map" class="map"></div>
    <script>
      let socket = new WebSocket('ws://localhost:8000/ws/polData/');
      // let numberofConnection = 0
      socket.onopen = function(e){
        alert(`New Connection Established,Total Connection`)
        
         
      }
      socket.onmessage = function(e){
        
        // console.log(JSON.parse(e.data).long)
        var RecData = JSON.parse(e.data);
        console.log(RecData)
        userId = RecData.riderId

        

        if (!UserIdList.includes(userId)){
          UserIdList.push(userId)
          AllFeatures.push(RecData)
        }

        AllFeatures.forEach(el => {
          if (userId == el.riderId){
            el.long =RecData.long;
            el.lat = RecData.lat
          }
        })
        console.log(UserIdList)

        console.log(AllFeatures);
        vectorSource.clear();
        AllFeatures.forEach(el => {
          var PointFeature = new ol.Feature({
        geometry: new ol.geom.Point([el.lat,el.long]),
        name: 'LiveLocation'
      }); 
      vectorSource.addFeature(PointFeature);
        })


        // geojsonObject.features[0].geometry.coordinates = [RecData.lat,RecData.long];

        // var coordinates = geojsonObject.features[0].geometry.coordinates;



      // var PointFeature = new ol.Feature({
      //   geometry: new ol.geom.Point(coordinates),
      //   name: 'LiveLocation'
      // });
      // var PointFeature0 = new ol.Feature({
      //   geometry: new ol.geom.Point([85.638377429864042, 27.619667651522228]),
      //   name: 'LiveLocation'
      // });
      
      // vectorSource.addFeature(PointFeature);
      // vectorSource.addFeature(PointFeature0);



        // geojsonObject.features[0].geometry.coordinates[1] = RecData.long;
        

        // geojsonObject.features[0].geometry.coordinates =[85.638377429864042, 27.619667651522228]
        // window.myLine.update()

        // vectorLayer.getSource().changed();
        // vectorLayer.changed();

        // vectorLayer.refresh({force:true});

        // vectorLayer.redraw()

        // map.updateSize();

        // vectorLayer.source().updateParams({CQL_FILTER:"1=1"});

        // vectorLayer.getSource().refresh()
    

        // map.render();
      };
      socket.onclose = function(e){
        alert("Connection Closed")
      }
    </script>
    <script type="text/javascript">
var UserIdList = []
var AllFeatures = []
var geojsonObject = {
"type": "FeatureCollection",
"name": "campus",
"crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
"features": [
{ "type": "Feature", "properties": { "id": 1, "name_id": "ku_corner_campus" }, "geometry": { "type": "Point", "coordinates": [ 85.538377429864042, 27.619667651522228 ] } },
]
}
const vectorSource = new ol.source.Vector({
  features: new ol.format.GeoJSON().readFeatures(geojsonObject),
});
const vectorLayer = new ol.layer.Vector({
  source: vectorSource,
  // style: styleFunction,
});
var DataObj = {
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          vectorLayer
        ],
        view: new ol.View({
          projection: 'EPSG:4326',
          center: [85.5386, 27.6195],
          zoom: 8
        })
      }
      var map = new ol.Map(DataObj);
      // map.addLayer(vectorLayer)
    </script>

  </body>
</html>

